<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <title>Nivi Jha | Portfolio</title>

  <!-- Theme preload -->
  <script>
    (function () {
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
        document.documentElement.classList.add("dark");
      }
    })();
  </script>

  <!-- Music state preload -->
  <script>
    (function () {
      const isPlaying = localStorage.getItem("musicPlaying") === "true";
      if (isPlaying) {
        document.documentElement.classList.add("music-playing");
      }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>

  <div id="theme-transition"></div>
  <%- include('../includes/navbar') %>

    <main>
      <%- body %>
    </main>

    <%- include('../includes/footer') %>

      <!-- GLOBAL SCRIPTS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
      <script src="https://unpkg.com/lucide@latest"></script>

      <!-- Lucide icons -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          lucide.createIcons();
        });
      </script>

      <!-- Theme toggle -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const toggleBtn = document.querySelector(".theme-toggle");
          const root = document.documentElement;
          const overlay = document.getElementById("theme-transition");

          if (!toggleBtn) return;

          toggleBtn.innerHTML = root.classList.contains("dark")
            ? '<i data-lucide="sun"></i>'
            : '<i data-lucide="moon"></i>';

          lucide.createIcons();

          toggleBtn.addEventListener("click", () => {
            const isDark = root.classList.contains("dark");

            const rect = toggleBtn.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;

            overlay.style.setProperty("--wipe-x", `${x}px`);
            overlay.style.setProperty("--wipe-y", `${y}px`);

            overlay.style.background = getComputedStyle(document.documentElement)
              .getPropertyValue("--bg-body");

            const maxRadius = Math.hypot(
              Math.max(x, window.innerWidth - x),
              Math.max(y, window.innerHeight - y)
            );

            const tl = gsap.timeline({
              defaults: { ease: "power4.inOut" }
            });

            tl.to(overlay, {
              clipPath: `circle(${maxRadius}px at ${x}px ${y}px)`,
              duration: 0.6,
              onComplete: () => {
                root.classList.toggle("dark", !isDark);
                localStorage.setItem("theme", !isDark ? "dark" : "light");

                toggleBtn.innerHTML = !isDark
                  ? '<i data-lucide="sun"></i>'
                  : '<i data-lucide="moon"></i>';

                lucide.createIcons();
              }
            }).to(overlay, {
              clipPath: `circle(0px at ${x}px ${y}px)`,
              duration: 0.55
            });
          });
        });
      </script>


      <!-- Year -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const yearEl = document.getElementById("year");
          if (yearEl) yearEl.textContent = new Date().getFullYear();
        });
      </script>

      <!-- NAV ACTIVE STATE -->
      <script>
        function updateActiveNav() {
          const currentPath = window.location.pathname;

          document.querySelectorAll(".nav-links a").forEach(link => {
            const linkPath = new URL(link.href).pathname;

            if (linkPath === currentPath) {
              link.classList.add("active");
              link.setAttribute("aria-current", "page");
            } else {
              link.classList.remove("active");
              link.removeAttribute("aria-current");
            }
          });
        }
      </script>

      <!-- PAGE SCRIPTS -->
      <script src="/js/home.js"></script>
      <script src="/js/about.js"></script>
      <script src="/js/skills.js"></script>
      <script src="/js/project.js"></script>
      <script src="/js/contactHandler.js"></script>

      <!-- PAGE INIT -->
      <script>
        function runPageInit() {
          console.log("Running page init…");

          if (document.querySelector(".about-section") && window.initAboutPage) {
            console.log("Init: About");
            window.initAboutPage();
          }

          if (document.querySelector(".projects-section") && window.initProjectsPage) {
            console.log("Init: Projects");
            window.initProjectsPage();
          }

          if (document.querySelector(".skills-section") && window.initSkillsPage) {
            console.log("Init: Skills");
            window.initSkillsPage();
          }

          if (document.querySelector(".contact-section") && window.initContactPage) {
            console.log("Init: Contact");
            window.initContactPage();
          }

          if (document.querySelector(".hero-section") && window.initHomePage) {
            console.log("Init: Home");
            window.initHomePage();
          }
        }
      </script>

      <!-- NAVIGATION + REVEAL + PROGRESS BAR -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {

          function initScrollProgress() {
            const bar = document.querySelector(".nav-progress-bar");
            if (!bar) return;

            function updateProgress() {
              const scrollTop = window.scrollY;
              const docHeight =
                document.documentElement.scrollHeight - window.innerHeight;

              const progress = docHeight > 0
                ? (scrollTop / docHeight) * 100
                : 0;

              bar.style.width = progress + "%";
            }

            window.addEventListener("scroll", updateProgress);
            updateProgress();
          }


          function initRevealAnimations() {
            const revealObserver = new IntersectionObserver(entries => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  entry.target.classList.add("visible");
                  revealObserver.unobserve(entry.target);
                }
              });
            }, { threshold: 0.15 });

            document.querySelectorAll(".reveal, .reveal-group").forEach(el => {
              revealObserver.observe(el);
            });
          }

          async function loadPage(url) {
            const currentMain = document.querySelector("main");

            currentMain.classList.add("page-exit");
            await new Promise(r => setTimeout(r, 420));

            const res = await fetch(url, { credentials: "same-origin" });
            const text = await res.text();

            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/html");

            const newMain = doc.querySelector("main");

            if (newMain && currentMain) {
              currentMain.innerHTML = newMain.innerHTML;
            }

            initRevealAnimations();
            runPageInit();
            initScrollProgress();


            currentMain.classList.remove("page-exit");
          }

          initRevealAnimations();
          runPageInit();
          updateActiveNav();

          document.querySelectorAll("a[href^='/']").forEach(link => {
            link.addEventListener("click", async (e) => {
              const url = link.getAttribute("href");
              if (url === window.location.pathname) return;

              e.preventDefault();

              await loadPage(url);

              window.history.pushState({}, "", url);
              updateActiveNav();
            });
          });

          window.addEventListener("popstate", async () => {
            await loadPage(window.location.pathname);
            updateActiveNav();
          });
        });
      </script>

      <!-- GLOBAL MUSIC ENGINE -->
      <script>
        (function () {
          if (!window.globalAudio) {
            const audio = new Audio("/music.mp3");
            audio.loop = true;
            audio.volume = 0.9;
            audio.preload = "auto";
            window.globalAudio = audio;
          }

          const audio = window.globalAudio;

          const isPlaying = localStorage.getItem("musicPlaying") === "true";
          const savedTime = parseFloat(localStorage.getItem("musicTime") || "0");

          if (!isNaN(savedTime)) {
            audio.currentTime = savedTime;
          }

          if (isPlaying) {
            audio.play().catch(() => { });
          }

          setInterval(() => {
            if (!audio.paused) {
              localStorage.setItem("musicTime", audio.currentTime);
            }
          }, 1000);
        })();
      </script>

      <!-- MUSIC BUTTON + EQ SYNC -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const btn = document.getElementById("music-btn");
          if (!btn || !window.globalAudio) return;

          const audio = window.globalAudio;

          function syncUI() {
            if (!audio.paused) {
              document.documentElement.classList.add("music-playing");
            } else {
              document.documentElement.classList.remove("music-playing");
            }
          }

          syncUI();

          btn.addEventListener("click", () => {
            if (audio.paused) {
              audio.play();
              localStorage.setItem("musicPlaying", "true");
            } else {
              audio.pause();
              localStorage.setItem("musicPlaying", "false");
            }
            syncUI();
          });

          audio.addEventListener("play", syncUI);
          audio.addEventListener("pause", syncUI);
        });
      </script>

      <!-- MUSIC TIP POPUP -->
      <script>
        window.addEventListener("load", () => {
          const tip = document.getElementById("music-tip");
          const btn = document.getElementById("music-btn");

          if (!tip || !btn) return;

          setTimeout(() => {
            tip.classList.add("show", "bounce");
            btn.classList.add("pulse");
          }, 900);

          setTimeout(() => {
            tip.classList.remove("show", "bounce");
            btn.classList.remove("pulse");
          }, 5200);
        });
      </script>

      <!-- HAMBURGER MOBILE SHEET -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          if (!document.querySelector(".mobile-sheet")) {
            const sheet = document.createElement("div");
            sheet.className = "mobile-sheet";
            sheet.setAttribute("aria-hidden", "true");
            sheet.style.display = "none";  // hidden by default on all screen sizes
            sheet.innerHTML = `
        <div class="mobile-sheet-backdrop"></div>
        <div class="mobile-sheet-card">
          <ul class="mobile-sheet-nav">
            <li><a href="/about">About <span class="nav-row-arrow"><i data-lucide="chevron-right"></i></span></a></li>
            <li><a href="/skills">Stack <span class="nav-row-arrow"><i data-lucide="chevron-right"></i></span></a></li>
            <li><a href="/projects">Projects <span class="nav-row-arrow"><i data-lucide="chevron-right"></i></span></a></li>
            <li><a href="/contact">Contact <span class="nav-row-arrow"><i data-lucide="chevron-right"></i></span></a></li>
          </ul>
          <div class="mobile-sheet-divider"></div>
          <div class="mobile-sheet-actions">
            <a href="https://drive.google.com/file/d/1QFgZbvDQn99wsy-nNUcoRNeySuxzbh1V"
               target="_blank" rel="noopener"
               class="mobile-sheet-action">
              <span class="mobile-sheet-action-label">
                <span class="mobile-sheet-action-icon resume-icon">↗</span>
                Resume
              </span>
            </a>
            <button class="mobile-sheet-action mobile-theme-toggle">
              <span class="mobile-sheet-action-label">
                <span class="mobile-sheet-action-icon theme-icon" id="mobile-theme-icon">
                  <i data-lucide="moon"></i>
                </span>
                <span id="mobile-theme-label">Dark mode</span>
              </span>
            </button>
          </div>
        </div>
      `;
            document.body.appendChild(sheet);
            lucide.createIcons();
          }

          function updateMobileThemeUI() {
            const isDark = document.documentElement.classList.contains("dark");
            const label = document.getElementById("mobile-theme-label");
            const iconWrap = document.getElementById("mobile-theme-icon");
            if (label) label.textContent = isDark ? "Light mode" : "Dark mode";
            if (iconWrap) {
              iconWrap.innerHTML = isDark
                ? '<i data-lucide="sun"></i>'
                : '<i data-lucide="moon"></i>';
              lucide.createIcons();
            }
          }

          updateMobileThemeUI();

          const toggle = document.querySelector(".nav-toggle");
          const sheet = document.querySelector(".mobile-sheet");
          const backdrop = document.querySelector(".mobile-sheet-backdrop");

          function openSheet() {
            sheet.style.display = "block";
            // Small delay so display:block applies before the transition
            requestAnimationFrame(() => {
              sheet.classList.add("open");
            });
            sheet.setAttribute("aria-hidden", "false");
            toggle.classList.add("active");
            toggle.setAttribute("aria-expanded", "true");
            document.body.style.overflow = "hidden";
          }

          function closeSheet() {
            sheet.classList.remove("open");
            sheet.setAttribute("aria-hidden", "true");
            toggle.classList.remove("active");
            toggle.setAttribute("aria-expanded", "false");
            document.body.style.overflow = "";
            setTimeout(() => {
              if (!sheet.classList.contains("open")) {
                sheet.style.display = "none";
              }
            }, 400);
          }

          // Always attach — CSS hides the toggle button on desktop anyway
          toggle.addEventListener("click", () => {
            sheet.classList.contains("open") ? closeSheet() : openSheet();
          });

          backdrop.addEventListener("click", closeSheet);

          document.querySelectorAll(".mobile-sheet-nav a").forEach(link => {
            link.addEventListener("click", closeSheet);
          });

          document.querySelector(".mobile-theme-toggle")?.addEventListener("click", () => {
            const desktopToggle = document.querySelector(".theme-toggle");
            if (desktopToggle) desktopToggle.click();
            setTimeout(updateMobileThemeUI, 700);
            closeSheet();
          });
        });
      </script>
</body>

</html>